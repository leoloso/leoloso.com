---
title: ðŸ’¯ Generating the schema with independently versioned fields and directives
metaDesc: Complementing evolution to manage changes to the schema in GraphQL by PoP
socialImage: /images/graphql-by-pop-logo.jpg
date: '2020-04-17'
tags:
  - pop
  - graphql
  - development
---

A few weeks ago I had added the ability to [independently version fields and directives](https://leoloso.com/posts/field-directive-versioning/) in GraphQL by PoP, by passing the version constraint as a field/directive argument when executing the query. This works well but has a problem: that specific version of the schema could be accessed only by running the query, but not by introspection. So we couldn't run clients or tools against it.

Today I have fixed this issue. Now, the specific version for a field/directive can be provided to the endpoint through URL params, so it can be incorporated when generating the schema artifact. This way, clients and tooling have complete visibility of all possible versions of the schema, allowing to:

- have a client coded in TypeScript be generated by pointing to the exact required schema
- point to a different version of the schema just by modifying the endpoint (eg: useful to wait for feature flags to kick in)
- visualize the schema in GraphQL Voyager, run queries in GraphiQL

## Params

Two new URL params to pass to the endpoint were created:

- `fieldVersionConstraints[]`
- `directiveVersionConstraints[]`

These params are arrays, so they can be defined multiple times in the URL as to version more than 1 field or directive. Directives are referenced directly by their name (without the `@`), like this:

```php
?directiveVersionConstraints[makeTitle]=^0.1&directiveVersionConstraints[upperCase]=~0.2
```

Fields are referenced as a combination of their type and their name, separated with a dot, like this:

```php
?fieldVersionConstraints[Post.title]=0.3.1&fieldVersionConstraints[User.name]=0.2|0.3
```

The type name can be namespaced or not, it will work in either case, with [automatic namespacing](https://leoloso.com/posts/added-namespaces-to-graphql-by-pop/) enabled or not.

Now, the algorithm follows this order to obtain the versioning of a field:

1. Versioning specified by field argument
2. Versioning specified by URL param `fieldVersionConstraints[]` on the namespaced type
3. Versioning specified by URL param `fieldVersionConstraints[]` on the non-namespaced type
4. Versioning specified by URL param `versionConstraint`

For directives it is similar, but in only 3 steps since they are not namespaced:

1. Versioning specified by directive argument
2. Versioning specified by URL param `directiveVersionConstraints[]` on the directive
3. Versioning specified by URL param `versionConstraint`

If no versioning is found on any of these steps, then the field or directive is not versioned.

## Demo

Let's check out some examples. In the GraphiQL clients below, the URL parameters `fieldVersionConstraints[]` and `directiveVersionConstraints[]` were added to the endpoint `/api/graphql/` (check it out in the Network tab in Firefox/Chrome DevTools).

In [this query](https://newapi.getpop.org/graphiql/?fieldVersionConstraints%5BRoot.userServiceURLs%5D=%5E0.2&query=query%20%7B%0A%20%20versionByFieldArg%3A%20userServiceURLs(versionConstraint%3A%220.1.0%22)%0A%20%20versionByURLParam%3A%20userServiceURLs%0A%7D), field `userServiceURLs` is queried with version `0.1.0` set by field argument, and with version `0.2.0` by default, as set through URL param `fieldVersionConstraints[Root.userServiceURLs]=^0.2`:

<div id="graphiql-1st" style="height: 65vh; padding-top: 0; margin-top: 1rem;" class="video-player"></div>

To double check that the default field has version `0.2.0`, we can click on the documentation explorer, browse to `Root.userServiceURLs`, and read the version added to its description:

> Services used in the application: GitHub data for a specific repository _(Version: 0.2.0)_

Or we can also [visualize it with GraphQL Voyager](https://newapi.getpop.org/graphql-interactive/?fieldVersionConstraints[Root.userServiceURLs]=^0.2&query=query%20{%0A%20%20versionByFieldArg:%20userServiceURLs(versionConstraint:%220.1.0%22)%0A%20%20versionByURLParam:%20userServiceURLs%0A}), which displays the schema for the specified exact combination of field and directive versions:

![Visualizing the field versioning by params in GraphQL Voyager](/images/field-versioning-by-params.png "Visualizing the field versioning by params in GraphQL Voyager")

It works the same way for directives. In [this query](https://newapi.getpop.org/graphiql/?directiveVersionConstraints%5BmakeTitle%5D=%5E0.1&query=query%20%7B%0A%20%20posts(limit%3A5)%20%7B%0A%20%20%20%20versionByURLParam%3A%20title%20%40makeTitle%0A%20%20%20%20versionByFieldArg%3A%20title%20%40makeTitle(versionConstraint%3A%22%5E0.2%22)%0A%20%20%7D%0A%7D), directive `makeTitle` is queried with version `0.2.0` set by directive argument, and with version `0.1.0` by default, as set through URL param `directiveVersionConstraints[makeTitle]=^0.1`:

<div id="graphiql-2nd" style="height: 65vh; padding-top: 0; margin-top: 1rem;" class="video-player"></div>

Of course they can be combined. In [this query](https://newapi.getpop.org/graphiql/?fieldVersionConstraints%5BRoot.userServiceURLs%5D=%5E0.2&fieldVersionConstraints%5BRoot.userServiceData%5D=%5E0.1&directiveVersionConstraints%5BmakeTitle%5D=%5E0.2&query=query%20%7B%0A%20%20userServiceURLs%0A%20%20userServiceData%0A%20%20posts(limit%3A5)%20%7B%0A%20%20%20%20title%20%40makeTitle%0A%20%20%7D%0A%7D) we are independently setting the version for fields `userServiceURLs` and `userServiceData`, and directive `makeTitle`:

<div id="graphiql-3rd" style="height: 65vh; padding-top: 0; margin-top: 1rem;" class="video-player"></div>

## What's next

I have added tons of new features to GraphQL by PoP lately. It is now finally time to work on providing documentation (so I am not the only one who can get to use it!). For that, the following weeks I will be completing the documentation on the newly-launched [GraphQL by PoP site](https://graphql-by-pop.com).

[GraphQL by PoP is currently available for WordPress](https://graphql-by-pop.com/docs/getting-started/installation/wordpress.html), to be installed via Composer. In the upcoming weeks/months, I will attempt to release the WordPress plugin, which will be very easy to install, and will contain several wonderful features:

- Persisted GraphQL queries
- Access Control Lists, to control who can access the schema, set-up on a field-by-field basis
- HTTP caching, configured through Cache Control Lists, to define the Cache-Control max-age on a field-by-field basis (and it will be smart: if a field cannot be cached, then the whole request will not be cached!); and internal caching for expensive operations

Most of the features are ready, and I can already say: they are so awesome! Check out this screenshot:

![Preview of an Access Control List in the WordPress plugin (WIP)](/images/wp-plugin-acl.png "Preview of an Access Control List in the WordPress plugin (WIP)")

Exciting times are coming!

## Don't be shy, contact me (I'm here to help)

If you install GraphQL by PoP and run into any trouble, let me know and I'll help: DM me [on Twitter](https://twitter.com/losoviz), chat on the [GraphQL Slack channel](https://graphql.slack.com), or [email](mailto:leo@getpop.org).

Arrivederci! ðŸ‘‹

<link href="https://unpkg.com/graphiql/graphiql.min.css" rel="stylesheet" />

<script
  crossorigin
  src="https://unpkg.com/react/umd/react.production.min.js"
></script>
<script
  crossorigin
  src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"
></script>
<script
  crossorigin
  src="https://unpkg.com/graphiql/graphiql.min.js"
></script>

<script>
  const responseText = "Click the \"Execute Query\" button";
  const endpointGraphQLFetcher = (endpoint, graphQLParams) =>
    fetch(endpoint, {
      method: 'post',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(graphQLParams),
    })
      .then(response => response.json())
      .catch(() => response.text());
  
  const apiURL = 'https://newapi.getpop.org/api/graphql/';
  const versionedAPIURL1 = `${ apiURL }?fieldVersionConstraints[Root.userServiceURLs]=^0.2`;
  const versionedGraphQLFetcher1 = graphQLParams => endpointGraphQLFetcher(versionedAPIURL1, graphQLParams);

  ReactDOM.render(
    React.createElement(
      GraphiQL, 
      { 
        fetcher: versionedGraphQLFetcher1,
        docExplorerOpen: false,
        response: responseText,
        query: "query {\n  versionByFieldArg: userServiceURLs(versionConstraint:\"^0.1.0\")\n  versionByURLParam: userServiceURLs\n}",
        variables: null,
        defaultVariableEditorOpen: false
      }
    ),
    document.getElementById('graphiql-1st'),
  );

  const versionedAPIURL2 = `${ apiURL }?directiveVersionConstraints[makeTitle]=^0.1`;
  const versionedGraphQLFetcher2 = graphQLParams => endpointGraphQLFetcher(versionedAPIURL2, graphQLParams);

  ReactDOM.render(
    React.createElement(
      GraphiQL, 
      { 
        fetcher: versionedGraphQLFetcher2,
        docExplorerOpen: false,
        response: responseText,
        query: "query {\n  posts(limit:5) {\n    versionByURLParam: title @makeTitle\n    versionByFieldArg: title @makeTitle(versionConstraint:\"^0.2\")\n  }\n}\n\n",
        variables: null,
        defaultVariableEditorOpen: false
      }
    ),
    document.getElementById('graphiql-2nd'),
  );

  const versionedAPIURL3 = `${ apiURL }?fieldVersionConstraints[Root.userServiceURLs]=^0.2&fieldVersionConstraints[Root.userServiceData]=^0.1&directiveVersionConstraints[makeTitle]=^0.2`;
  const versionedGraphQLFetcher3 = graphQLParams => endpointGraphQLFetcher(versionedAPIURL3, graphQLParams);
  
  ReactDOM.render(
    React.createElement(
      GraphiQL, 
      { 
        fetcher: versionedGraphQLFetcher3,
        docExplorerOpen: false,
        response: responseText,
        query: "query {\n  userServiceURLs\n  userServiceData\n  posts(limit:5) {\n    title @makeTitle\n  }\n}",
        variables: null,
        defaultVariableEditorOpen: false
      }
    ),
    document.getElementById('graphiql-3rd'),
  );
</script>
